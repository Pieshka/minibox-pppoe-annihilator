#!/bin/sh

# Load Minibox configuration
. /etc/minibox.static
. /etc/minibox.cfg

# Proxy ARP configuration
if [ "$1" = "$LAN_IF" ] && [ "$2" = "up" ]; then
    # Load dynamic configuration and check if we have IP
    if [ -f "/var/run/minibox.dynamic" ]; then
        . /var/run/minibox.dynamic
        # PPP_GW contains target gateway but only if netmask is /32
        if [ -n "$PPP_GW" ] && [ "$LAN_MASK" = "32" ]; then
            /usr/bin/logger -p "daemon.info" -t "[MNBOX-IFPLUGD]" "Detected link up on $LAN_IF. Resetting ARP proxy entries."
            /usr/sbin/arp -s "$PPP_GW" -i "$LAN_IF" -D "$LAN_IF" pub
        fi
    fi
fi

# LAN LED activation
if [ "$1" = "$LAN_IF" ]; then
    value=0
    [ "$2" = "up" ] && value=1

    for led in /sys/class/leds/*:green:lan/brightness; do
        [ -f "$led" ] && echo $value > "$led"
    done
fi

# Exit cleanly
exit 0